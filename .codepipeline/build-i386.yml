version: 0.2

phases:
  install:
    commands:
      - docker pull kuzzleio/sdk-cross:i386
      - sysctl -w vm.max_map_count=262144
  build:
    commands:
      - docker run -a stdout -a stderr --net host --rm --privileged \
          --name build-machine \
          --mount type=bind,source="$(pwd)",target=/go/src/github.com/kuzzleio/sdk-go \
          kuzzleio/sdk-cross:i386 /build.sh
  post_build:
    commands:
      - bash .codepipeline/start_kuzzle.sh
      - docker run -a stdout -a stderr --privileged --rm \
          --network codepipeline_default \
          --link kuzzle \
          --name test-machine \
          --mount type=bind,source="$(pwd)",target=/go/src/github.com/kuzzleio/sdk-go \
          kuzzleio/sdk-cross:i386 /test.sh
      - docker kill codepipeline_elasticsearch_1 codepipeline_redis_1 kuzzle
